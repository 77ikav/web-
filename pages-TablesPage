<style>
:root {
    --primary-color: #667eea;
    --sidebar-width: 320px;
    --sidebar-collapsed-width: 40px; /* æ”¶èµ·åçš„å®½åº¦ */
    --bg-gray: #f0f2f5;
    --danger-color: #ef4444;
  }

  /* ä¾§è¾¹æ æ”¶èµ·æ—¶çš„ç±» */
  .fixed-sidebar.collapsed {
    width: var(--sidebar-collapsed-width);
    overflow: hidden;
  }
  .fixed-sidebar.collapsed .sidebar-section {
    display: none; /* æ”¶èµ·æ—¶éšè—æ‰€æœ‰å†…å®¹ */
  }
  .content-area.expanded {
    margin-right: var(--sidebar-collapsed-width);
  }

  /* æŠ˜å æŒ‰é’®æ ·å¼ */
  .toggle-sidebar-btn {
    position: absolute;
    left: -15px;
    top: 20px;
    width: 30px;
    height: 30px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 101;
    font-size: 12px;
  }
  
  body { margin: 0; padding: 0; background: var(--bg-gray); font-family: sans-serif; }

  /* å¸ƒå±€ç»“æ„ */
  .main-layout { display: flex; min-height: 100vh; }
  .content-area { flex: 1; padding: 20px; margin-right: var(--sidebar-width); }

  /* å³ä¾§å›ºå®šé¢æ¿ */
  .fixed-sidebar {
    width: var(--sidebar-width);
    position: fixed; right: 0; top: 0; bottom: 0;
    background: white; border-left: 1px solid #e2e8f0;
    padding: 20px; box-sizing: border-box;
    display: flex; flex-direction: column; gap: 20px;
    box-shadow: -2px 0 10px rgba(0,0,0,0.05); z-index: 100;
  }

  /* å¡ç‰‡è®¾è®¡ */
  .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
  .customer-card {
    background: white; border-radius: 12px; padding: 16px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;
    transition: all 0.2s; border: 1px solid transparent;
    display: flex; flex-direction: column; gap: 8px;
  }
  .customer-card:hover { transform: translateY(-3px); border-color: var(--primary-color); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

  /* çŠ¶æ€æ¡ */
  .status-line { font-size: 12px; padding: 6px 10px; border-radius: 6px; background: #f8fafc; margin-top: 4px; }
  .status-red { color: #ef4444; background: #fef2f2; border: 1px solid #fee2e2; }
  .status-green { color: #10b981; background: #f0fdf4; border: 1px solid #dcfce7; }
  .memo-preview { font-size: 11px; color: #94a3b8; border-top: 1px solid #f1f5f9; padding-top: 8px; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }

  /* ä¾§è¾¹æ æ§ä»¶ */
  .sidebar-section h3 { margin: 0 0 12px 0; font-size: 15px; color: #1e293b; }
  .search-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
  .parse-textarea { width: 100%; height: 180px; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; resize: none; box-sizing: border-box; background: #f8fafc; }

  /* æç¤ºå±•ç¤ºåŒº */
  .parse-result-hint { font-size: 12px; color: #10b981; margin-top: 8px; display: none; font-weight: bold; text-align: center; }
  .copy-strip {
    margin-top: 10px; padding: 10px; background: #f1f5f9; border-radius: 6px;
    font-size: 12px; color: #475569; cursor: pointer; border: 1px dashed #cbd5e1;
    word-break: break-all; transition: all 0.2s; display: none;
  }
  .copy-strip:hover { background: #e2e8f0; border-color: var(--primary-color); }

  /* æŒ‰é’® */
  .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; width: 100%; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-primary { background: var(--primary-color); color: white; }
  .btn-secondary { background: #f1f5f9; color: #475569; }
  .btn-danger { background: #fee2e2; color: var(--danger-color); }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loading-icon { animation: spin 1s linear infinite; display: none; }
  .btn.is-loading .loading-icon { display: inline-block; }
  .btn.is-loading .btn-text { display: none; }

  /* è¯¦æƒ…å¼¹çª— */
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
  .detail-modal { background: white; width: 95%; max-width: 800px; border-radius: 16px; max-height: 90vh; display: flex; flex-direction: column; }
  .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
  .full-width { grid-column: 1 / -1; }

  @media (max-width: 1024px) { .content-area { margin-right: 0; } .fixed-sidebar { position: static; width: 100%; } .main-layout { flex-direction: column; } }
</style>

<div class="main-layout">
  <div class="content-area">
    <div class="cards-grid" id="cardsContainer"></div>
  </div>

<div class="fixed-sidebar" id="sidebar">
  <div class="toggle-sidebar-btn" onclick="window.toggleSidebar()" id="toggleBtn">â–¶</div>
  
  <div class="sidebar-section">
    <h3>ğŸ” å…¨å±€å…³è”æœç´¢</h3>
      <input type="text" id="tableSearchInput" class="search-input" placeholder="å§“å/ç”µè¯/çŠ¶æ€(å¦‚:å·²æ¶ˆè€—)..." onkeyup="window.filterTableContent()">
    </div>

    <div class="sidebar-section">
      <h3>â• æ–‡æœ¬è§£ææ·»åŠ </h3>
      <textarea id="parseInput" class="parse-textarea" placeholder="åœ¨æ­¤ç²˜è´´ç”³è¯·å†…å®¹..."></textarea>
      <button id="parseBtn" class="btn btn-primary" style="margin-top:10px;" onclick="window.parseAndFillContent()">
        <span class="loading-icon">âŒ›</span>
        <span class="btn-text">âœ“ ç«‹å³è§£æå¹¶æ·»åŠ </span>
      </button>
      <div id="parseRowHint" class="parse-result-hint"></div>
      <div id="copyStrip" class="copy-strip" title="ç‚¹å‡»ä¸€é”®å¤åˆ¶" onclick="window.copyToClipboard(this.innerText)"></div>
    </div>

    <div class="sidebar-section" style="margin-top: auto;">
      <button id="refreshBtn" class="btn btn-secondary" onclick="window.refreshTableContent()">
        <span class="loading-icon">âŒ›</span>
        <span class="btn-text">ğŸ”„ åˆ·æ–°å…¨éƒ¨æ•°æ®</span>
      </button>
      <p style="font-size: 11px; color: #94a3b8; text-align: center; margin-top: 10px;">å·²æŒ‰æœ€æ–°å½•å…¥å†…å®¹å€’æ’</p>
    </div>
  </div>
</div>

<div class="modal-overlay" id="detailModal">
  <div class="detail-modal">
    <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
      <h2 style="margin:0; font-size: 18px;">å®¢æˆ·æ¡£æ¡ˆè¯¦æƒ…</h2>
      <button onclick="window.closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
    </div>
    <div style="overflow-y: auto; flex: 1;">
      <div class="detail-grid" id="modalContent"></div>
    </div>
    <div id="modalFooter" style="padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px;">
      </div>
  </div>
</div>

<script>
  let tableData = [];
  let visibleRows = [];

  window.toggleSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const content = document.querySelector('.content-area');
    const btn = document.getElementById('toggleBtn');
    
    const isCollapsed = sidebar.classList.toggle('collapsed');
    content.classList.toggle('expanded');
    
    // æ”¹å˜æŒ‰é’®æ–‡å­—å’Œæ–¹å‘
    btn.innerText = isCollapsed ? 'â—€' : 'â–¶';
    
    // å¦‚æœæ˜¯å±•å¼€ï¼Œå°è¯•åˆ·æ–°ä¸€æ¬¡å¸ƒå±€
    if (!isCollapsed) {
       window.filterTableContent();
    }
  };

  // 1. åˆå§‹åŒ–æ¸²æŸ“ï¼šæŒ‰æ•°æ®åŸæœ¬é¡ºåºå€’åºï¼ˆå³æœ€æ–°å½•å…¥åœ¨æœ€å‰ï¼‰
  window.renderTableContent = function(data) {
    if(!data) return;
    // ä¸å†æ ¹æ® Date æ’åºï¼Œç›´æ¥åè½¬æ•°ç»„æ˜¾ç¤ºæœ€æ–°è¡Œ
    tableData = data.reverse(); 
    window.filterTableContent();
  };

  // 2. åˆ·æ–°å‡½æ•°
  window.refreshTableContent = function() {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('is-loading');
    google.script.run
      .withSuccessHandler(data => {
        btn.classList.remove('is-loading');
        window.renderTableContent(data); 
      })
      .withFailureHandler(() => {
        btn.classList.remove('is-loading');
        alert("åŒæ­¥å¤±è´¥");
      })
      .getCustomerData();
  };

  // 3. æœç´¢ä¸çŠ¶æ€è¿‡æ»¤
  window.filterTableContent = function() {
    const kw = document.getElementById('tableSearchInput').value.toLowerCase().trim();
    if (!kw) {
      visibleRows = tableData.map((_, i) => i);
    } else {
      visibleRows = tableData
        .map((c, i) => ({c, i}))
        .filter(item => {
          const d = item.c;
          const textMatch = Object.values(d).join(' ').toLowerCase().includes(kw);
          
          // çŠ¶æ€å¿«æ·æœç´¢
          let statusMatch = false;
          if (kw.includes('å·²æ¶ˆè€—') || kw === 'æ¶ˆè€—') statusMatch = !!d.usedCard;
          else if (kw.includes('å·²éªŒå¡') || kw === 'éªŒå¡') statusMatch = !!d.verifiedCard;
          else if (kw.includes('å¾…å¤„ç†')) statusMatch = !d.usedCard && !d.verifiedCard;
          
          return textMatch || statusMatch;
        })
        .map(x => x.i);
    }
    renderCards();
  };

  // 4. å¡ç‰‡ç”Ÿæˆ
  function renderCards() {
    const container = document.getElementById('cardsContainer');
    container.innerHTML = '';
    if (visibleRows.length === 0) {
      container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#94a3b8;">æœªæ‰¾åˆ°åŒ¹é…è®°å½•</div>';
      return;
    }
    visibleRows.forEach(idx => {
      const c = tableData[idx];
      const card = document.createElement('div');
      card.className = 'customer-card';
      card.onclick = () => openDetail(idx);
      
      let statusHtml = c.usedCard ? `<div class="status-line status-red">ğŸ”´ å·²æ¶ˆè€—ï¼š${c.usedCard}</div>` :
                       (c.verifiedCard ? `<div class="status-line status-green">ğŸŸ¢ å·²éªŒå¡ï¼š${c.verifiedCard}</div>` : 
                       `<div class="status-line" style="color:#94a3b8;">âšª å¾…å¤„ç†</div>`);

      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:start;">
          <strong style="font-size:16px; color:#1e293b;">${c.name || 'æœªå‘½å'}</strong>
          <span style="font-size:11px; color:#94a3b8;">${c.date || '-'}</span>
        </div>
        <div style="font-size:13px; color:#475569;">
          <div>ğŸ“ ${c.phone || '-'}</div>
          <div style="margin-top:2px; color:#6366f1; font-size:11px;">ğŸ‘¤ ${c.recommender || 'ç”µé”€'}</div>
        </div>
        ${statusHtml}
        <div class="memo-preview">${c.remarks ? 'ğŸ“ ' + c.remarks : 'æ— å¤‡æ³¨'}</div>
      `;
      container.appendChild(card);
    });
  }

  // 5. æ–‡æœ¬è§£ææ·»åŠ 
  window.parseAndFillContent = function() {
    const text = document.getElementById('parseInput').value;
    if(!text.trim()) return;
    const btn = document.getElementById('parseBtn');
    btn.classList.add('is-loading');

    google.script.run.withSuccessHandler(res => {
      btn.classList.remove('is-loading');
      if(res.ok) {
        // æ ¼å¼åŒ–å¤åˆ¶å†…å®¹ï¼š[å§“å]
        // ç›´æ¥ä½¿ç”¨åç«¯ä¼ å›çš„å·²æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ‰‹åŠ¨ç”Ÿæˆä¸€ä¸ª
        const dateStr = res.data.date || `${new Date().getMonth() + 1}æœˆ${new Date().getDate()}æ—¥`;
        const province = (res.data.address || "æ— ").substring(0, 2);
        const copyStr = `[${res.data.name}]ä¸¨å¾…éªŒè¯ä¸¨${res.data.recommender || 'ç”µé”€'}ä¸¨${res.data.age || 'æ— '}-${province}-${dateStr}-${res.data.phone || 'æ— '}`;
        
        const strip = document.getElementById('copyStrip');
        strip.innerText = copyStr;
        strip.style.display = 'block';

        // æ’å…¥æœ¬åœ°å¹¶åˆ·æ–°
        tableData.unshift({...res.data, originalIndex: 9999}); // ä¸´æ—¶å ä½ï¼Œåˆ·æ–°ä¼šæ ¡æ­£
        window.filterTableContent();
        document.getElementById('parseInput').value = '';
        window.refreshTableContent(); 
      }
    }).fillTable(text);
  };

  // 6. å¤åˆ¶åŠŸèƒ½ï¼ˆé™é»˜æç¤ºï¼‰
  window.copyToClipboard = function(text) {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);

    const hint = document.getElementById('parseRowHint');
    hint.innerText = 'âœ¨ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
    hint.style.display = 'block';
    setTimeout(() => { hint.style.display = 'none'; }, 2000);
  };

  // 7. è¯¦æƒ…ä¸åˆ é™¤
  function openDetail(idx) {
    const c = tableData[idx];
    const content = document.getElementById('modalContent');
    const fields = [
      {label: 'æ—¥æœŸ', key: 'date'}, {label: 'å§“å', key: 'name'},
      {label: 'å¹´é¾„', key: 'age'}, {label: 'æ‰‹æœºå·', key: 'phone'},
      {label: 'åœ°å€', key: 'address'}, {label: 'æ¨èäºº', key: 'recommender'},
      {label: 'å·²éªŒå¡', key: 'verifiedCard'}, {label: 'å·²æ¶ˆå¡', key: 'usedCard'},
      {label: 'é“¶è¡Œå¡', key: 'bankCard', full: true},
      {label: 'å¤‡æ³¨', key: 'remarks', full: true, area: true}
    ];
    content.innerHTML = fields.map(f => `
      <div style="display:flex; flex-direction:column; gap:5px;" class="${f.full ? 'full-width' : ''}">
        <label style="font-size:12px; font-weight:600;">${f.label}</label>
        ${f.area ? `<textarea id="edit_${f.key}" style="height:80px; padding:8px; border:1px solid #ddd;">${c[f.key] || ''}</textarea>` :
          `<input type="text" id="edit_${f.key}" value="${c[f.key] || ''}" style="padding:8px; border:1px solid #ddd;">`}
      </div>
    `).join('');

    document.getElementById('modalFooter').innerHTML = `
      <button class="btn btn-danger" style="width: auto; padding: 10px;" onclick="window.deleteCustomer(${idx})">ğŸ—‘ï¸ åˆ é™¤</button>
      <button class="btn btn-secondary" style="width: auto; flex: 1;" onclick="window.closeModal()">å–æ¶ˆ</button>
      <button id="modalSaveBtn" class="btn btn-primary" style="width: auto; flex: 2;" onclick="saveEdit(${idx})">ä¿å­˜æ›´æ–°</button>
    `;
    document.getElementById('detailModal').style.display = 'flex';
  }

  window.deleteCustomer = function(idx) {
    const c = tableData[idx];
    if(!confirm(`ç¡®å®šè¦åˆ é™¤ [${c.name}] å—ï¼Ÿ`)) return;
    google.script.run.withSuccessHandler(() => {
      tableData.splice(idx, 1);
      window.filterTableContent();
      window.closeModal();
    }).deleteCustomerRow(c.originalIndex);
  };

  function saveEdit(idx) {
    const updated = {
      date: document.getElementById('edit_date').value,
      name: document.getElementById('edit_name').value,
      age: document.getElementById('edit_age').value,
      phone: document.getElementById('edit_phone').value,
      address: document.getElementById('edit_address').value,
      recommender: document.getElementById('edit_recommender').value,
      remarks: document.getElementById('edit_remarks').value,
      bankCard: document.getElementById('edit_bankCard').value,
      verifiedCard: document.getElementById('edit_verifiedCard').value,
      usedCard: document.getElementById('edit_usedCard').value
    };
    google.script.run.withSuccessHandler(res => {
      if(res.ok) {
        tableData[idx] = {...updated, originalIndex: tableData[idx].originalIndex};
        window.renderTableContent(tableData.reverse()); // æ¢å¤æ˜¾ç¤º
        window.closeModal();
      }
    }).updateCustomerData(tableData[idx].originalIndex, updated);
  }

  window.closeModal = function() { document.getElementById('detailModal').style.display = 'none'; };
  window.onload = window.refreshTableContent;
</script>
