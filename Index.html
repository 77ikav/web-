<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f0f2f5;
      overflow: hidden;
    }
    
    /* ä¸»å®¹å™¨ */
    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      flex-direction: column;
    }
    
    /* é¡¶éƒ¨æ  */
    .navbar {
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 100;
    }
    
    .menu-toggle-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      margin-right: 15px;
      transition: background 0.3s;
    }

    .menu-toggle-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .navbar-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .navbar-logo {
      font-size: 24px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    .navbar-title {
      font-size: 18px;
      font-weight: 500;
      border-left: 2px solid rgba(255,255,255,0.5);
      padding-left: 20px;
    }
    
    .navbar-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding-right: 15px;
      border-right: 1px solid rgba(255,255,255,0.3);
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    /* ä¸»ä½“å¸ƒå±€ */
    .app-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* å·¦ä¾§èœå• */
    .sidebar {
      width: 260px;
      background: #1f2937;
      color: #fff;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
      z-index: 50;
      transition: margin-left 0.3s ease;
    }

    .sidebar.collapsed {
      margin-left: -260px;
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding-top: 20px;
    }
    
    .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #d1d5db;
      transition: all 0.3s;
      border-left: 3px solid transparent;
      font-size: 14px;
      font-weight: 500;
    }
    
    .menu-item:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
    
    .menu-item.active {
      background: rgba(102, 126, 234, 0.2);
      color: #fff;
      border-left-color: #667eea;
    }
    
    .menu-icon {
      font-size: 18px;
      min-width: 24px;
      text-align: center;
    }
    
    .menu-label {
      flex: 1;
    }
    
    /* å†…å®¹åŒº */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #f0f2f5;
    }
    
    .content-header {
      padding: 20px 30px;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .content-header h1 {
      font-size: 24px;
      color: #1f2937;
      margin: 0;
      font-weight: 600;
    }
    
    .content-header p {
      font-size: 13px;
      color: #6b7280;
      margin: 5px 0 0 0;
    }
    
    .content-body {
      flex: 1;
      overflow: auto;
      padding: 20px 30px;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- é¡¶éƒ¨æ  -->
    <nav class="navbar">
      <div class="navbar-left">
        <button class="menu-toggle-btn" onclick="toggleSidebar()" title="åˆ‡æ¢èœå•">â˜°</button>
        <div class="navbar-logo">ğŸ“Š</div>
        <div class="navbar-title" id="navTitle">å…³ç³»é“¾ç®¡ç†ç³»ç»Ÿ</div>
      </div>
      <div class="navbar-right">
        <div class="user-info">
          <div class="user-avatar">ğŸ‘¤</div>
          <span id="userName">åŠ è½½ä¸­...</span>
        </div>
      </div>
    </nav>
    
    <!-- ä¸»ä½“ -->
    <div class="app-body">
      <!-- å·¦ä¾§èœå• -->
      <div class="sidebar">
        <div class="sidebar-content" id="sidebarMenu">
          <!-- èœå•é¡¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      
      <!-- å†…å®¹åŒº -->
      <div class="main-content">
        <div class="content-header" id="contentHeader">
          <h1 id="pageTitle">åŠ è½½ä¸­...</h1>
          <p id="pageDesc"></p>
        </div>
        <div class="content-body" id="contentBody">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¸­...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // èœå•é…ç½®
    const menus = [
      { id: 'tables', label: 'å®¢æˆ·åˆ—è¡¨', icon: 'ğŸ“‹', title: 'å®¢æˆ·ç®¡ç†', desc: 'æŸ¥çœ‹å’Œç¼–è¾‘æ‰€æœ‰å®¢æˆ·ä¿¡æ¯' },
      { id: 'relationship', label: 'å…³ç³»é“¾', icon: 'ğŸ”—', title: 'å…³ç³»é“¾è§†å›¾', desc: 'æŸ¥çœ‹å®¢æˆ·æ¨èå…³ç³»é“¾' },
      { id: 'statistics', label: 'æ•°æ®ç»Ÿè®¡', icon: 'ğŸ“ˆ', title: 'ç»Ÿè®¡åˆ†æ', desc: 'å®¢æˆ·æ•°æ®ç»Ÿè®¡åˆ†æ' },
      { id: 'settings', label: 'è®¾ç½®', icon: 'âš™ï¸', title: 'ç³»ç»Ÿè®¾ç½®', desc: 'ç³»ç»Ÿé…ç½®é€‰é¡¹' }
    ];
    
    let currentPage = 'tables';
    let allData = [];
    
    // åˆå§‹åŒ–
    function init() {
      renderMenus();
      loadPage('tables');
      loadCurrentUser();
      // é»˜è®¤æŠ˜å å·¦ä¾§èœå•
      toggleSidebar();
    }
    
    // æ¸²æŸ“èœå•
    function renderMenus() {
      const menuContainer = document.getElementById('sidebarMenu');
      menuContainer.innerHTML = menus.map(menu => `
        <div class="menu-item ${menu.id === currentPage ? 'active' : ''}" onclick="switchPage('${menu.id}')">
          <span class="menu-icon">${menu.icon}</span>
          <span class="menu-label">${menu.label}</span>
        </div>
      `).join('');
    }
    
    // åˆ‡æ¢é¡µé¢
    function switchPage(pageId) {
      currentPage = pageId;
      renderMenus();
      loadPage(pageId);
    }
    
    // åˆ‡æ¢å·¦ä¾§èœå•æŠ˜å /å±•å¼€
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      sidebar.classList.toggle('collapsed');
    }
    
    // åŠ è½½é¡µé¢
    function loadPage(pageId) {
      const menu = menus.find(m => m.id === pageId);
      if (!menu) return;
      
      document.getElementById('navTitle').textContent = menu.title;
      document.getElementById('pageTitle').textContent = menu.title;
      document.getElementById('pageDesc').textContent = menu.desc;
      
      const contentBody = document.getElementById('contentBody');
      contentBody.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>åŠ è½½ä¸­...</p></div>';
      
      // æ ¹æ®é¡µé¢ ID åŠ è½½å¯¹åº”å†…å®¹
      google.script.run
        .withSuccessHandler(html => {
          // å°†æœåŠ¡å™¨è¿”å›çš„ HTML æ’å…¥åˆ°å†…å®¹åŒº
          contentBody.innerHTML = html;

          // æ‰§è¡Œæ’å…¥ HTML ä¸­çš„å†…è”è„šæœ¬ï¼ˆæµè§ˆå™¨ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œé€šè¿‡ innerHTML æ’å…¥çš„ scriptï¼‰
          const scripts = Array.from(contentBody.querySelectorAll('script'));
          scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            if (oldScript.src) {
              newScript.src = oldScript.src;
            } else {
              newScript.textContent = oldScript.textContent || oldScript.innerHTML;
            }
            document.body.appendChild(newScript);
            // ç§»é™¤åŸå§‹ scriptï¼Œé¿å…é‡å¤
            oldScript.parentNode && oldScript.parentNode.removeChild(oldScript);
          });

          // é¡µé¢åŠ è½½åæ‰§è¡Œåˆå§‹åŒ–å›è°ƒï¼šç­‰å¾…é¡µé¢å†…è”è„šæœ¬æ³¨å†Œå…¨å±€å‡½æ•°åå†è°ƒç”¨
          function waitForGlobal(fnName, cb, timeout = 3000) {
            const start = Date.now();
            (function poll() {
              if (window[fnName]) return cb();
              if (Date.now() - start > timeout) return cb(new Error('timeout'));
              setTimeout(poll, 100);
            })();
          }

          if (pageId === 'tables') {
            waitForGlobal('renderTableContent', (err) => {
              if (err) console.warn('renderTableContent æœªåœ¨é¡µé¢ä¸­æ³¨å†Œï¼Œä»å°†å°è¯•åˆå§‹åŒ–');
              initTablesPage();
            });
          } else if (pageId === 'relationship') {
            waitForGlobal('renderRelationshipChainContent', (err) => {
              if (err) console.warn('renderRelationshipChainContent æœªåœ¨é¡µé¢ä¸­æ³¨å†Œï¼Œä»å°†å°è¯•åˆå§‹åŒ–');
              initRelationshipPage();
            });
          }
        })
        .withFailureHandler(err => {
          contentBody.innerHTML = '<div style="padding:20px; color:#dc2626;">åŠ è½½å¤±è´¥: ' + (err.message || err) + '</div>';
        })
        .getPageContent(pageId);
    }
    
    // é€€å‡º
    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
        google.script.host.close();
      }
    }
    
    // è·å–å¹¶æ˜¾ç¤ºå½“å‰ç”¨æˆ·é‚®ç®±
    function loadCurrentUser() {
      google.script.run
        .withSuccessHandler(result => {
          if (result.ok && result.email) {
            document.getElementById('userName').textContent = result.email;
          } else {
            document.getElementById('userName').textContent = 'ç”¨æˆ·';
          }
        })
        .withFailureHandler(err => {
          document.getElementById('userName').textContent = 'ç”¨æˆ·';
        })
        .getCurrentUserEmail();
    }
    
    // é¡µé¢åˆå§‹åŒ–å‡½æ•°ï¼ˆåœ¨åŠ è½½å¯¹åº”é¡µé¢ HTML åæ‰§è¡Œï¼‰
    function initTablesPage() {
      // è¡¨æ ¼é¡µé¢é€»è¾‘
      loadCustomerData();
    }
    
    function initRelationshipPage() {
      // å…³ç³»é“¾é¡µé¢é€»è¾‘
      loadRelationshipChain();
    }
    
    // åŠ è½½å®¢æˆ·æ•°æ®ï¼ˆä¾›è¡¨æ ¼é¡µé¢ä½¿ç”¨ï¼‰
    function loadCustomerData() {
      google.script.run
        .withSuccessHandler(data => {
          if (data && data.error) {
            document.getElementById('contentBody').innerHTML = '<div style="padding:20px; color:#dc2626;">é”™è¯¯: ' + data.error + '</div>';
            return;
          }
          allData = data.customers || [];
          // å¦‚æœç‰‡æ®µæ¸²æŸ“å‡½æ•°å°šæœªæ³¨å†Œï¼Œè½®è¯¢ç­‰å¾…çŸ­æ—¶é—´å†è°ƒç”¨ï¼Œé¿å…ä¸¢å¤±æ•°æ®
          (function deliverToFragment(payload, timeout = 3000) {
            const start = Date.now();
            (function poll() {
              if (window.renderTableContent) {
                try { window.renderTableContent(payload); } catch (e) { console.warn('è°ƒç”¨ renderTableContent å‡ºé”™', e); }
                return;
              }
              if (Date.now() - start > timeout) {
                // å›é€€åˆ°å…¨å±€æ¸²æŸ“é€»è¾‘
                try { renderTable(); } catch (e) { console.warn('renderTable è°ƒç”¨å¤±è´¥', e); }
                return;
              }
              setTimeout(poll, 100);
            })();
          })(allData);
        })
        .withFailureHandler(err => {
          document.getElementById('contentBody').innerHTML = '<div style="padding:20px; color:#dc2626;">åŠ è½½å¤±è´¥: ' + (err.message || err) + '</div>';
        })
        .getRelationshipChainData();
    }
    
    // åŠ è½½å…³ç³»é“¾æ•°æ®ï¼ˆä¾›å…³ç³»é“¾é¡µé¢ä½¿ç”¨ï¼‰
    function loadRelationshipChain() {
      google.script.run
        .withSuccessHandler(data => {
          if (data && data.error) {
            document.getElementById('contentBody').innerHTML = '<div style="padding:20px; color:#dc2626;">é”™è¯¯: ' + data.error + '</div>';
            return;
          }
          allData = data.customers || [];
          // å¦‚æœç‰‡æ®µæ¸²æŸ“å‡½æ•°å°šæœªæ³¨å†Œï¼Œè½®è¯¢ç­‰å¾…çŸ­æ—¶é—´å†è°ƒç”¨ï¼Œé¿å…ä¸¢å¤±æ•°æ®
          (function deliverToFragment(payload, timeout = 3000) {
            const start = Date.now();
            (function poll() {
              if (window.renderRelationshipChainContent) {
                try { window.renderRelationshipChainContent(payload); } catch (e) { console.warn('è°ƒç”¨ renderRelationshipChainContent å‡ºé”™', e); }
                return;
              }
              if (Date.now() - start > timeout) {
                // å›é€€åˆ°å…¨å±€æ¸²æŸ“é€»è¾‘
                try { renderRelationshipChain(); } catch (e) { console.warn('renderRelationshipChain è°ƒç”¨å¤±è´¥', e); }
                return;
              }
              setTimeout(poll, 100);
            })();
          })(allData);
        })
        .withFailureHandler(err => {
          document.getElementById('contentBody').innerHTML = '<div style="padding:20px; color:#dc2626;">åŠ è½½å¤±è´¥: ' + (err.message || err) + '</div>';
        })
        .getRelationshipChainData();
    }
    
    // è¡¨æ ¼æ¸²æŸ“ï¼ˆç®€åŒ–ç‰ˆï¼Œå®Œæ•´é€»è¾‘è§ä¸‹æ–¹ï¼‰
    function renderTable() {
      const contentBody = document.getElementById('contentBody');
      const hasTableFragment = !!document.getElementById('tableBodyMain') || !!document.getElementById('tableContainer');

      if (allData.length === 0) {
        // å¦‚æœè¡¨æ ¼ç‰‡æ®µå·²åŠ è½½ï¼Œè°ƒç”¨ç‰‡æ®µçš„æ¸²æŸ“å‡½æ•°è®©å…¶æ˜¾ç¤ºç©ºçŠ¶æ€ï¼›å¦åˆ™åœ¨ contentBody æ˜¾ç¤ºæš‚æ— æ•°æ®
        if (hasTableFragment && window.renderTableContent) {
          window.renderTableContent([]);
        } else {
          contentBody.innerHTML = '<div style="text-align:center; padding:60px 20px; color:#999;">æš‚æ— æ•°æ®</div>';
        }
        return;
      }

      // å¦‚æœè¡¨æ ¼ç‰‡æ®µå­˜åœ¨ä¸”æä¾›æ¸²æŸ“æ¥å£ï¼Œåˆ™äº¤ç»™ç‰‡æ®µæ¸²æŸ“ï¼›å¦åˆ™ç›´æ¥åœ¨ contentBody æ˜¾ç¤ºä¸€æ¡æç¤º
      if (hasTableFragment && window.renderTableContent) {
        window.renderTableContent(allData);
      } else {
        contentBody.innerHTML = '<div style="text-align:center; padding:60px 20px; color:#999;">æš‚æ— æ•°æ®</div>';
      }
    }
    
    // å…³ç³»é“¾æ¸²æŸ“
    function renderRelationshipChain() {
      const contentBody = document.getElementById('contentBody');
      const hasRelationshipFragment = !!document.querySelector('.relationship-page') || !!document.getElementById('relationshipContainer');

      if (allData.length === 0) {
        if (hasRelationshipFragment && window.renderRelationshipChainContent) {
          window.renderRelationshipChainContent([]);
        } else {
          contentBody.innerHTML = '<div style="text-align:center; padding:60px 20px; color:#999;">æš‚æ— æ•°æ®</div>';
        }
        return;
      }

      if (hasRelationshipFragment && window.renderRelationshipChainContent) {
        window.renderRelationshipChainContent(allData);
      } else {
        contentBody.innerHTML = '<div style="text-align:center; padding:60px 20px; color:#999;">æš‚æ— æ•°æ®</div>';
      }
    }
    
    // çŠ¶æ€æç¤º
    window.showStatus = function showStatus(message, type) {
      const statusEl = document.createElement('div');
      statusEl.style.cssText = `
        position: fixed;
        top: 80px;
        right: 30px;
        padding: 12px 20px;
        border-radius: 4px;
        z-index: 1000;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
      `;
      
      const colors = {
        success: '#d1fae5',
        error: '#fee2e2',
        info: '#dbeafe'
      };
      const textColors = {
        success: '#065f46',
        error: '#7f1d1d',
        info: '#082f49'
      };
      
      statusEl.style.backgroundColor = colors[type] || colors.info;
      statusEl.style.color = textColors[type] || textColors.info;
      statusEl.textContent = message;
      document.body.appendChild(statusEl);
      
      setTimeout(() => statusEl.remove(), 3000);
    }

    // ç®€æ˜“è°ƒè¯•é¢æ¿ï¼ˆå³ä¸Šè§’ï¼‰ï¼Œç”¨äºæ˜¾ç¤ºä»æœåŠ¡å™¨è¿”å›çš„è°ƒè¯•ä¿¡æ¯
    window.showDebugPanel = function showDebugPanel(obj) {
      let panel = document.getElementById('debugPanel');
      if (!panel) {
        panel = document.createElement('div');
        panel.id = 'debugPanel';
        panel.style.cssText = 'position:fixed; right:20px; top:80px; width:320px; max-height:300px; overflow:auto; background:#111827; color:#e5e7eb; padding:12px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.2); font-size:12px; z-index:1200;';
        document.body.appendChild(panel);
      }
      panel.innerHTML = '<strong style="display:block; margin-bottom:6px; color:#60a5fa;">è°ƒè¯•ä¿¡æ¯</strong><pre style="white-space:pre-wrap; word-break:break-word; margin:0;">' + JSON.stringify(obj, null, 2) + '</pre>';
      setTimeout(() => { try { panel.remove(); } catch(e){} }, 15000);
    }
    
    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
